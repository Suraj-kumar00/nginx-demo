# Rate limiting zones - Define these in http context
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;
limit_req_zone $binary_remote_addr zone=login:10m rate=2r/s;
limit_req_zone $binary_remote_addr zone=search:10m rate=5r/s;
limit_req_zone $binary_remote_addr zone=strict:10m rate=1r/s;

# Connection limiting zones
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
limit_conn_zone $server_name zone=conn_limit_per_server:10m;

# Global connection limits
limit_conn conn_limit_per_ip 20;
limit_conn conn_limit_per_server 100;

# Rate limit status code (default is 503)
limit_req_status 429;
limit_conn_status 429;

# Log rate limit violations
limit_req_log_level warn;
limit_conn_log_level warn;

# Rate limiting rules for different endpoints
# These should be applied in server or location blocks

# Example usage in location blocks:
# 
# # General pages - 10 requests per second with burst of 20
# location / {
#     limit_req zone=general burst=20 nodelay;
# }
#
# # API endpoints - 30 requests per second with burst of 50
# location /api/ {
#     limit_req zone=api burst=50 nodelay;
# }
#
# # Login endpoint - 2 requests per second with burst of 5
# location /login {
#     limit_req zone=login burst=5 nodelay;
# }
#
# # Search endpoint - 5 requests per second with burst of 10
# location /search {
#     limit_req zone=search burst=10 nodelay;
# }
#
# # Strict rate limiting - 1 request per second with burst of 3
# location /admin/ {
#     limit_req zone=strict burst=3 nodelay;
# }

# Whitelist for trusted IPs (optional)
# geo $limit_key {
#     default $binary_remote_addr;
#     10.0.0.0/8 "";
#     192.168.0.0/16 "";
#     172.16.0.0/12 "";
# }
# 
# # Use $limit_key instead of $binary_remote_addr in limit_req_zone
# # to exclude whitelisted IPs from rate limiting

# Rate limiting by user agent (optional)
# map $http_user_agent $rate_limit_key {
#     default $binary_remote_addr;
#     ~*(bot|crawler|spider) $binary_remote_addr;
#     ~*curl "";  # Exclude curl from rate limiting for testing
# }
